"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2792],{3905:(e,n,t)=>{t.d(n,{Zo:()=>s,kt:()=>k});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var u=a.createContext({}),p=function(e){var n=a.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},s=function(e){var n=p(e.components);return a.createElement(u.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,u=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),c=p(t),m=i,k=c["".concat(u,".").concat(m)]||c[m]||d[m]||r;return t?a.createElement(k,l(l({ref:n},s),{},{components:t})):a.createElement(k,l({ref:n},s))}));function k(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,l=new Array(r);l[0]=m;var o={};for(var u in n)hasOwnProperty.call(n,u)&&(o[u]=n[u]);o.originalType=e,o[c]="string"==typeof e?e:i,l[1]=o;for(var p=2;p<r;p++)l[p]=t[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},5743:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=t(7462),i=(t(7294),t(3905));const r={id:"policier",title:"\ud83d\udd10 Policier JWT Auth"},l=void 0,o={unversionedId:"en/policier",id:"version-4.x/en/policier",title:"\ud83d\udd10 Policier JWT Auth",description:"- Installation",source:"@site/versioned_docs/version-4.x/en/policier.md",sourceDirName:"en",slug:"/en/policier",permalink:"/docs/en/policier",draft:!1,editUrl:"https://github.com/bowphp/docs/edit/main/website/docs/en/policier.md",tags:[],version:"4.x",lastUpdatedBy:"Franck DAKIA",lastUpdatedAt:1672493455,formattedLastUpdatedAt:"Dec 31, 2022",frontMatter:{id:"policier",title:"\ud83d\udd10 Policier JWT Auth"}},u={},p=[{value:"Installation",id:"installation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Utilisation",id:"utilisation",level:2},{value:"Mise \xe0 jour ou R\xe9cup\xe9ration de la configuration",id:"mise-\xe0-jour-ou-r\xe9cup\xe9ration-de-la-configuration",level:3},{value:"Mise \xe0 jour de la Configuration",id:"mise-\xe0-jour-de-la-configuration",level:4},{value:"R\xe9cup\xe9ration de la Configuration",id:"r\xe9cup\xe9ration-de-la-configuration",level:4},{value:"Encoder un Token",id:"encoder-un-token",level:3},{value:"D\xe9coder un Token",id:"d\xe9coder-un-token",level:3},{value:"Transformer un Token",id:"transformer-un-token",level:3},{value:"V\xe9rifier un Token",id:"v\xe9rifier-un-token",level:3},{value:"Valider un Token",id:"valider-un-token",level:3},{value:"Bow Framework et Policier",id:"bow-framework-et-policier",level:2},{value:"Personnalisation du Middleware",id:"personnalisation-du-middleware",level:3},{value:"Publier le middleware",id:"publier-le-middleware",level:4},{value:"Il manque quelque chose ?",id:"il-manque-quelque-chose-",level:2}],s={toc:p};function c(e){let{components:n,...t}=e;return(0,i.kt)("wrapper",(0,a.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#installation"},"Installation")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#configuration"},"Configuration")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#utilisation"},"Utilisation"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#mise-%C3%A0-jour-ou-r%C3%A9cup%C3%A9ration-de-la-configuration"},"Mise \xe0 jour ou R\xe9cup\xe9ration de la configuration"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#mise-%C3%A0-jour-de-la-configuration"},"Mise \xe0 jour de la Configuration")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#r%C3%A9cup%C3%A9ration-de-la-configuration"},"R\xe9cup\xe9ration de la Configuration")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#encoder-un-token"},"Encoder un Token")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#d%C3%A9coder-un-token"},"D\xe9coder un Token")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#transformer-un-token"},"Transformer un Token")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#v%C3%A9rifier-un-token"},"V\xe9rifier un Token")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#valider-un-token"},"Valider un Token")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#bow-framework-et-policier"},"Bow Framework et Policier"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#personnalisation-du-middleware"},"Personnalisation du Middleware"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#publier-le-middleware"},"Publier le middleware"))))))),(0,i.kt)("h2",{id:"installation"},"Installation"),(0,i.kt)("p",null,"Policier permet de valider la demande via ",(0,i.kt)("a",{parentName:"p",href:"https://jwt.io"},"JWT")),(0,i.kt)("p",null,"Pour installer la strat\xe9gie d'installation, vous devez utiliser ",(0,i.kt)("inlineCode",{parentName:"p"},"composer")," (gestionnaire de paquets PHP) comme ceci."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"composer require bowphp/policier\n")),(0,i.kt)("h2",{id:"configuration"},"Configuration"),(0,i.kt)("p",null,"Vous pouvez regarder toutes les options de configuration ici."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'return [\n  /**\n   * Heure d\'expiration du token\n   */\n  "exp" => 3600,\n\n  /**\n   * Le token est utilisable apr\xe8s cette heure\n   */\n  "nbf" => 60,\n\n  /**\n   * Le token \xe9tait \xe9mis\n   */\n  "iat" => 60,\n\n  /**\n   * Configure l\'\xe9metteur\n   */\n  "iss" => "localhost",\n\n  /**\n   * Configure le public\n   */\n  "aud" => "localhost",\n\n  /**\n   * Algorithme de hachage utilis\xe9\n   *\n   * HS256, HS384, HS512, RS256, RS384, RS512, ES256, ES384, ES512,\n   */\n  "alg" => "HS512",\n\n  /**\n   * Votre Signature, ce champs est obligatoire pour les autres type de hachage sauf RSA\n   */\n  \'signkey\' => null,\n\n  /**\n   * Signature en utilisant votre RSA, ce chargera automatique si la cl\xe9 de hashage est de type RSA\n   */\n  "keychain" => [\n    /**\n     * Chemin vers votre cl\xe9 priv\xe9e\n     */\n    "private" => null,\n\n    /**\n     * Chemin vers votre cl\xe9 publique\n     */\n    "public" => null\n  ]\n];\n')),(0,i.kt)("h2",{id:"utilisation"},"Utilisation"),(0,i.kt)("p",null,"Policier est tr\xe8s simple d'utilisation et poss\xe8de une API claire. La configuration retourne une singleton."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'use Policier\\Policier;\n\n$configure = require "/path/to/config/file.php";\n\n$policier = Policier::configure($configure);\n')),(0,i.kt)("p",null,"Vous pouvez aussi faire comme ceci:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'use Policier\\Policier;\n\n$configure = require "/path/to/config/file.php";\n\nPolicier::configure($configure);\n\n$policier = Policier::getInstance();\n')),(0,i.kt)("p",null,"Apr\xe8s la configuration, vous pouvez utiliser le helper ",(0,i.kt)("inlineCode",{parentName:"p"},"policier"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"policier($action, ...$args);\n")),(0,i.kt)("p",null,"La valeur d'action doit \xeatre l'une de ces valeurs: ",(0,i.kt)("inlineCode",{parentName:"p"},"encode"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"decode"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"parse"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"verify"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"validate"),"."),(0,i.kt)("h3",{id:"mise-\xe0-jour-ou-r\xe9cup\xe9ration-de-la-configuration"},"Mise \xe0 jour ou R\xe9cup\xe9ration de la configuration"),(0,i.kt)("h4",{id:"mise-\xe0-jour-de-la-configuration"},"Mise \xe0 jour de la Configuration"),(0,i.kt)("p",null,"Vous pouvez mettre \xe0 jour la configuration de base avec la m\xe9thode ",(0,i.kt)("inlineCode",{parentName:"p"},"setConfig"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"$policier->setConfig('exp', time() + 72000);\n")),(0,i.kt)("h4",{id:"r\xe9cup\xe9ration-de-la-configuration"},"R\xe9cup\xe9ration de la Configuration"),(0,i.kt)("p",null,"Vous pouvez \xe9galement obtenir les informations de configuration avec la m\xe9thode ",(0,i.kt)("inlineCode",{parentName:"p"},"getConfig"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"$policier->getConfig('exp');\n")),(0,i.kt)("h3",{id:"encoder-un-token"},"Encoder un Token"),(0,i.kt)("p",null,"Encoder rapidement un token:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'$id = uniqid();\n\n$claims = [\n  "name" => "Franck",\n  "nickname" => "papac",\n  "logged" => true\n];\n\n$token = $policier->encode($id, $claims);\n\n$token->expireIn(); // Expired In\n$token->getToken(); // Token value\n\necho $token;\n//=> eyJ0eX...OiJKV1.eyJpc3Mi...OiJsb2.l7v0bS0r...qnK1IeR\n')),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"$token")," est une instance de ",(0,i.kt)("inlineCode",{parentName:"p"},"Policier\\Token")," et impl\xe9mente la m\xe9thode magique ",(0,i.kt)("inlineCode",{parentName:"p"},"__toString"),". Vous pouvez obtenir l'heure d'expiration avec ",(0,i.kt)("inlineCode",{parentName:"p"},"expiredIn")," et ",(0,i.kt)("inlineCode",{parentName:"p"},"getToken")," pour prendre la valeur du token."),(0,i.kt)("p",null,"Via l'assistant:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"policier('encode', $id, $claims);\n")),(0,i.kt)("h3",{id:"d\xe9coder-un-token"},"D\xe9coder un Token"),(0,i.kt)("p",null,"M\xeame chose pour le d\xe9codage de token:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"$result = $policier->decode($token);\n$result['headers'];\n\necho $result['claims']['name'];\n//=> Franck\n")),(0,i.kt)("p",null,"Via l'assistant:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"policier('decode', $token);\n")),(0,i.kt)("h3",{id:"transformer-un-token"},"Transformer un Token"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'$token = $policier->parse($token);\n\n$token->hasHeader("old") // V\xe9rifier si l\'en-t\xeate existe\n$token->getHeader("alg", $default = null); // Obtenez un en-t\xeate\n$token->getHeaders(); // Obtenir tous les en-t\xeates\n\n$token->hasClaim("name") // V\xe9rifier si la r\xe9clamation existe\n$token->getClaim("name", $default = null); // Obtenez une r\xe9clamation\n$token->getClaims(); // Obtenez toutes les r\xe9clamations\n\n$token->isExpired(); // V\xe9rifier si le token a expir\xe9\n\necho $token->getClaim("name");\n//=> Franck\n')),(0,i.kt)("p",null,"Via l'assistant:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"policier('parse', $token);\n")),(0,i.kt)("h3",{id:"v\xe9rifier-un-token"},"V\xe9rifier un Token"),(0,i.kt)("p",null,"V\xe9rifier si le jeton est valide avec tous les attributs JWT."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'$verified = $policier->verify($token);\n\nif ($verified) {\n  echo "Token est valide";\n} else {\n  echo "Token n\'est pas valide";\n}\n')),(0,i.kt)("p",null,"Via l'assistant:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"policier('verify', $token);\n")),(0,i.kt)("h3",{id:"valider-un-token"},"Valider un Token"),(0,i.kt)("p",null,"Validez le jeton avec les informations de r\xe9clamation et les informations ",(0,i.kt)("inlineCode",{parentName:"p"},"exp"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'$claims = [\n  "name" => "Franck",\n  "nickname" => "papac",\n  "logged" => true\n];\n\n$validated = $policier->validate($token, $claims);\n\nif ($validated) {\n  echo "Les informations sont valides";\n} else {\n  echo "Les informations ne sont pas valides";\n}\n')),(0,i.kt)("p",null,"Via l'assistant:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'$claims = [\n  "name" => "Franck",\n  "nickname" => "papac",\n  "logged" => true\n];\n\npolicier(\'validate\', $token, $claims);\n')),(0,i.kt)("h2",{id:"bow-framework-et-policier"},"Bow Framework et Policier"),(0,i.kt)("p",null,"Si vous utilisez ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bowphp/app"},"Bow Framework"),", vous pouvez utiliser le plugin de configuration ",(0,i.kt)("inlineCode",{parentName:"p"},"Policier\\Bow\\PolicierConfiguration::class")," et le middleware ",(0,i.kt)("inlineCode",{parentName:"p"},"Policier\\Bow\\PolicierMiddleware::class"),"."),(0,i.kt)("p",null,"Relier la configuration sur ",(0,i.kt)("inlineCode",{parentName:"p"},"app\\Kernel\\Loader.php"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"public function middlewares()\n{\n  return [\n    ...\n    'policier' => \\Policier\\Bow\\PolicierMiddleware::class,\n    ...\n  ];\n}\n\npublic function configurations()\n{\n  return [\n    ...\n    \\Policier\\Bow\\PolicierConfiguration::class,\n    ...\n  ];\n}\n")),(0,i.kt)("p",null,"Utilisez le middleware:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"$app->get('/api', function () {\n  $token  = policier()->getToken();\n})->middleware('policier');\n")),(0,i.kt)("p",null,"Le token a \xe9t\xe9 analys\xe9 dans l'instance de Policier dans le processus middleware via la m\xe9thode ",(0,i.kt)("inlineCode",{parentName:"p"},"plug"),". Apr\xe8s l'ex\xe9cution du middleware, vous pouvez:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Obtenez le token avec ",(0,i.kt)("inlineCode",{parentName:"li"},"getToken")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#decode-token"},"D\xe9coder")," le token avec ",(0,i.kt)("inlineCode",{parentName:"li"},"getDecodeToken")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"#parse-token"},"Analyser")," le token avec ",(0,i.kt)("inlineCode",{parentName:"li"},"getParsedToken"))),(0,i.kt)("h3",{id:"personnalisation-du-middleware"},"Personnalisation du Middleware"),(0,i.kt)("p",null,"Notez que vous pouvez cr\xe9er un autre middleware qui \xe9tendra le middleware par defaut ",(0,i.kt)("inlineCode",{parentName:"p"},"Policier\\Bow\\PolicierMiddleware::class"),". Ce qui vous donne la possibilit\xe9 de changer les messages d'erreur en surchargant les methodes ",(0,i.kt)("inlineCode",{parentName:"p"},"getUnauthorizedMessage"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"getExpirateMessage"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"getExpirateCode")," et ",(0,i.kt)("inlineCode",{parentName:"p"},"getUnauthorizedCode"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"php bow add:middleware CustomPolicierMiddleware\n")),(0,i.kt)("p",null,"Et ensuite vous pouvez faire ceci:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"\nuse Bow\\Http\\Request;\nuse Policier\\Bow\\PolicierMiddleware;\n\nclass CustomPolicierMiddleware extends PolicierMiddleware\n{\n  /**\n   * Obtenir le message d'erreur\n   *\n   * @return array\n   */\n  public function getUnauthorizedMessage()\n  {\n    return [\n      'message' => 'unauthorized',\n      'error' => true\n    ];\n  }\n\n  /**\n   * Obtenir le message d'expiration du token\n   *\n   * @return array\n   */\n  public function getExpirationMessage()\n  {\n    return [\n      'message' => 'token is expired',\n      'expired' => true,\n      'error' => true\n    ];\n  }\n\n  /**\n   * Obtenir le code de r\xe9ponse non autoris\xe9\n   *\n   * @return int\n   */\n  public function getUnauthorizedStatusCode()\n  {\n    return 403;\n  }\n\n  /**\n   * Obtenir le code de r\xe9ponse\n   *\n   * @return int\n   */\n  public function getExpirationStatusCode()\n  {\n    return 403;\n  }\n}\n")),(0,i.kt)("h4",{id:"publier-le-middleware"},"Publier le middleware"),(0,i.kt)("p",null,"Pour publier le middleware personnalis\xe9 et \xe9craser celui par defaut de Policier c'est tr\xe8s simple, il suffit seulement d'ajouter le middleware dans le fichier ",(0,i.kt)("inlineCode",{parentName:"p"},"app/Kernel/Loader.php")," avec la cl\xe9 ",(0,i.kt)("inlineCode",{parentName:"p"},"api"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"public function middlewares()\n{\n  return [\n    ...\n    'policier' => \\App\\Middleware\\CustomPolicierMiddleware::class,\n    ...\n  ];\n}\n")),(0,i.kt)("h2",{id:"il-manque-quelque-chose-"},"Il manque quelque chose ?"),(0,i.kt)("p",null,"Si vous rencontrez des probl\xe8mes avec la documentation ou si vous avez des suggestions pour am\xe9liorer la documentation ou le projet en g\xe9n\xe9ral, veuillez d\xe9poser une issue pour nous, ou envoyer un tweet mentionnant le compte Twitter @BowFramework ou sur directement sur le ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bowphp/docs/issues"},"github"),"."))}c.isMDXComponent=!0}}]);